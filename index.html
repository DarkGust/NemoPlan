<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dykker-gruppe prototype</title>
  <style>
    :root{--bg:#0b2436;--card:#083048;--muted:#9fb7c9;--accent:#2fb8d6}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto; margin:0;background:linear-gradient(180deg,#06202b 0%, #083048 100%);color:#e6f7ff}
    header{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.03)}
    h1{margin:0;font-size:18px}
    .wrap{display:flex;gap:12px;padding:12px;align-items:flex-start}
    .col{background:rgba(255,255,255,0.03);border-radius:10px;padding:10px;min-width:220px;max-width:420px;flex:1}
    .col h2{margin:0 0 8px 0;font-size:14px}
    .list{min-height:120px;padding:8px;display:flex;flex-wrap:wrap;gap:8px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));padding:8px 10px;border-radius:8px;cursor:grab;box-shadow:0 2px 6px rgba(0,0,0,0.4);display:flex;align-items:center;gap:8px}
    .card .emoji{font-size:20px}
    .card .meta{font-size:13px}
    .lvl1{border-left:4px solid #6fe3c9}
    .lvl2{border-left:4px solid #66b4e6}
    .lvl3{border-left:4px solid #2f8fd4}
    .pairBox, .groupBox{background:rgba(0,0,0,0.15);border-radius:8px;padding:6px;min-height:60px}
    .boxHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .small{font-size:12px;color:var(--muted)}
    button{background:var(--accent);border:none;color:#02323b;padding:6px 8px;border-radius:6px;cursor:pointer}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .groupBox{margin-bottom:10px}
    .groupHeader{display:flex;gap:8px;align-items:center}
    .groupHeader .name{font-weight:600}
    .timeRow{display:flex;gap:6px;align-items:center;margin-top:6px}
    input[type=time]{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit;padding:4px;border-radius:6px}
    .saveNote{font-size:12px;color:#bcd8e6;margin-top:8px}
    .export{margin-top:8px}
    footer{padding:10px 16px;font-size:13px;color:var(--muted)}
    @media (max-width:900px){.wrap{flex-direction:column}}
  </style>
  <!-- SortableJS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
  <header>
    <h1>Dykker-gruppe prototype ‚Äî havtema & farvekoder (1‚òÖ-3‚òÖ)</h1>
  </header>
  <div class="wrap">
    <div class="col" style="flex:0.9">
      <h2>Fremm√∏dte dykkere</h2>
      <div class="list" id="divers"></div>
      <div class="controls" style="margin-top:8px">
        <button id="resetBtn">Nulstil</button>
        <button id="clearStorage">Slet gemt</button>
      </div>
      <p class="saveNote">Tr√¶k en dykker over i et tomt par ("Opret par") for at starte et makkerpar. Par fyldt med 2 dykkere kan tr√¶kkes ind i en gruppe; grupper kan rumme op til 4 dykkere.<br>Regel: 1‚òÖ + 3‚òÖ i samme makkerpar er ikke tilladt.</p>
    </div>

    <div class="col" style="flex:1.1">
      <h2>Makkerpar</h2>
      <div style="display:flex;gap:8px;flex-direction:column" id="pairsArea"></div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="addPair">Opret par</button>
        <button id="autoPairs">Auto-par (fors√∏g)</button>
      </div>
      <h2 style="margin-top:12px">Grupper (4)</h2>
      <div id="groupsArea"></div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="addGroup">Opret gruppe</button>
        <button id="exportCsv">Eksport√©r CSV</button>
      </div>
    </div>

    <div class="col" style="flex:0.8">
      <h2>Log / Historik</h2>
      <div id="logList" style="max-height:420px;overflow:auto"></div>
    </div>
  </div>

  <footer>
    √Öbn denne fil i Chrome eller Safari p√• iPhone. Brug "F√∏j til hjemmesk√¶rm" for at f√• app-agtig oplevelse. Gem gemmes i browserens localStorage p√• denne enhed.
  </footer>

<script>
// --- Initial divers (20) ---
const initialDivers = [
  {name:'Peter', lvl:1, theme:'S√∏stjerne', emoji:'‚≠ê'},
  {name:'Lise', lvl:2, theme:'Skildpadde', emoji:'üê¢'},
  {name:'Ole', lvl:3, theme:'Delfin', emoji:'üê¨'},
  {name:'Anna', lvl:1, theme:'Musling', emoji:'ü¶™'},
  {name:'Mette', lvl:2, theme:'Bl√¶ksprutte', emoji:'ü¶ë'},
  {name:'Bo', lvl:3, theme:'Haj', emoji:'ü¶à'},
  {name:'Kim', lvl:1, theme:'S√∏hest', emoji:'ü™∏'},
  {name:'Eva', lvl:2, theme:'Makrel', emoji:'üêü'},
  {name:'Kasper', lvl:3, theme:'Bl√•hval', emoji:'üêã'},
  {name:'Finn', lvl:1, theme:'Tangn√•l', emoji:'üêå'},
  {name:'Poul', lvl:2, theme:'S√∏l√∏ve', emoji:'ü¶≠'},
  {name:'Marie', lvl:3, theme:'Kaskelot', emoji:'üêã'},
  {name:'Anders', lvl:1, theme:'Koral', emoji:'ü™∏'},
  {name:'Sofie', lvl:2, theme:'Havkat', emoji:'üê†'},
  {name:'Thomas', lvl:3, theme:'Sp√¶khugger', emoji:'üêã'},
  {name:'Laura', lvl:1, theme:'Sandorm', emoji:'ü™±'},
  {name:'Jesper', lvl:2, theme:'Sardin', emoji:'üêü'},
  {name:'Nicoline', lvl:3, theme:'Hammerhaj', emoji:'ü¶à'},
  {name:'Henrik', lvl:1, theme:'S√∏anemone', emoji:'üåä'},
  {name:'Camilla', lvl:2, theme:'Flyvefisk', emoji:'üê†'}
];

// DOM refs
const diversEl = document.getElementById('divers');
const pairsArea = document.getElementById('pairsArea');
const groupsArea = document.getElementById('groupsArea');
const logList = document.getElementById('logList');

let state = {divers:[], pairs:[], groups:[], log:[]};

// helpers
function saveState(){localStorage.setItem('dive_state', JSON.stringify(state));}
function loadState(){const s=localStorage.getItem('dive_state'); if(s) state=JSON.parse(s); else state={divers:initialDivers.map((d,i)=>({...d,id:'d'+i})), pairs:[], groups:[], log:[]};}
function clearStorage(){localStorage.removeItem('dive_state'); loadState(); renderAll();}

function createDiverCard(d){
  const el = document.createElement('div');
  el.className = 'card '+(d.lvl==1?'lvl1':d.lvl==2?'lvl2':'lvl3');
  el.draggable = true; el.dataset.id = d.id;
  el.innerHTML = `<div class="emoji">${d.emoji}</div><div class="meta"><div><strong>${d.name}</strong></div><div class="small">${d.theme} ‚Ä¢ ${d.lvl}‚òÖ</div></div>`;
  return el;
}

function renderDivers(){diversEl.innerHTML=''; state.divers.forEach(d=>{
  diversEl.appendChild(createDiverCard(d));
});
  // make Sortable
  Sortable.create(diversEl, {group:{name:'shared',pull:'clone',put:false},animation:150,sort:false});
}

function renderPairs(){pairsArea.innerHTML='';
  state.pairs.forEach((p,idx)=>{
    const box = document.createElement('div'); box.className='pairBox'; box.dataset.idx=idx;
    const header = document.createElement('div'); header.className='boxHeader'; header.innerHTML=`<div><strong>Par ${idx+1}</strong> <span class="small">(${p.id})</span></div><div><button data-action="clear">Ryd</button></div>`;
    box.appendChild(header);
    const list = document.createElement('div'); list.className='list pairList'; list.dataset.pair=idx;
    p.members.forEach(id=>{
      const d = state.divers.find(x=>x.id===id); if(d) list.appendChild(createDiverCard(d));
    });
    box.appendChild(list);
    pairsArea.appendChild(box);
    Sortable.create(list,{group:'shared',animation:150, onAdd: evt=>onAddToPair(evt,idx)});
    header.querySelector('button').onclick = ()=>{p.members=[]; renderAll(); saveState();};
  });
}

function renderGroups(){groupsArea.innerHTML='';
  state.groups.forEach((g,idx)=>{
    const box = document.createElement('div'); box.className='groupBox'; box.dataset.idx=idx;
    const header = document.createElement('div'); header.className='groupHeader';
    header.innerHTML = `<div class="name">Gruppe ${idx+1} <span class="small">(${g.name||'‚Äî'})</span></div><div><button data-action="save">Gem dyk</button> <button data-action="clear">Ryd</button></div>`;
    box.appendChild(header);
    const list = document.createElement('div'); list.className='list groupList'; list.dataset.group=idx;
    g.members.forEach(id=>{const d=state.divers.find(x=>x.id===id); if(d) list.appendChild(createDiverCard(d));});
    box.appendChild(list);
    const timeRow = document.createElement('div'); timeRow.className='timeRow'; timeRow.innerHTML = `Start: <input type="time" value="${g.start||''}" data-field="start"> Slut: <input type="time" value="${g.end||''}" data-field="end"> <input placeholder="grupnavn" value="${g.name||''}" data-field="name">`;
    box.appendChild(timeRow);
    groupsArea.appendChild(box);
    Sortable.create(list,{group:'shared',animation:150, onAdd: evt=>onAddToGroup(evt,idx)});
    header.querySelector('[data-action=save]').onclick = ()=>saveDive(idx);
    header.querySelector('[data-action=clear]').onclick = ()=>{g.members=[]; g.start=''; g.end=''; g.name=''; renderAll(); saveState();};
    timeRow.querySelectorAll('input').forEach(inp=>inp.onchange=()=>{const f=inp.dataset.field; g[f]=inp.value; saveState(); renderAll();});
  });
}

function onAddToPair(evt,pairIdx){
  const id = evt.item.dataset.id; // item cloned
  // if item is coming from a group or other pair, remove from original place
  // ensure pair size <=2
  const pair = state.pairs[pairIdx];
  // Find real id (evt.item.dataset.id exists)
  // Prevent duplicate
  if(pair.members.includes(id)){
    renderAll(); return;
  }
  if(pair.members.length>=2){ alert('Par kan kun have 2 dykkere'); renderAll(); return; }
  // Check levels to avoid 1+3
  const willMembers = [...pair.members, id];
  const lvls = willMembers.map(m=>state.divers.find(d=>d.id===m).lvl);
  if(lvls.includes(1) && lvls.includes(3)){
    alert('Regel: 1‚òÖ + 3‚òÖ m√• ikke v√¶re i samme makkerpar'); renderAll(); return;
  }
  // Remove id from any other pair/group
  removeMemberFromAll(id);
  pair.members.push(id);
  saveState(); renderAll();
}

function onAddToGroup(evt,groupIdx){
  const id = evt.item.dataset.id;
  const group = state.groups[groupIdx];
  if(group.members.includes(id)){ renderAll(); return; }
  if(group.members.length>=4){ alert('Gruppen kan have maks 4 dykkere'); renderAll(); return; }
  removeMemberFromAll(id);
  group.members.push(id);
  saveState(); renderAll();
}

function removeMemberFromAll(id){
  state.pairs.forEach(p=>{p.members=p.members.filter(m=>m!==id)});
  state.groups.forEach(g=>{g.members=g.members.filter(m=>m!==id)});
}

function renderLog(){logList.innerHTML=''; state.log.slice().reverse().forEach(entry=>{
  const el = document.createElement('div'); el.className='card'; el.style.marginBottom='6px';
  el.innerHTML = `<div><strong>${entry.groupName||'Gruppe'}</strong> ‚Ä¢ ${entry.start} - ${entry.end}</div><div class="small">${entry.members.map(id=>state.divers.find(d=>d.id===id)?.name || id).join(', ')}</div>`;
  logList.appendChild(el);
});}

function saveDive(groupIdx){
  const g = state.groups[groupIdx];
  if(g.members.length<2){ alert('Gruppen skal have mindst 2 dykkere for at gemme dyk'); return; }
  if(!g.start || !g.end) { if(!confirm('Ingen start eller slut valgt ‚Äî gem alligevel?')) return; }
  state.log.push({members:[...g.members], start:g.start||'', end:g.end||'', groupName:g.name||`Gruppe ${groupIdx+1}`, ts:new Date().toISOString()});
  // clear group
  g.members=[]; g.start=''; g.end=''; g.name=''; saveState(); renderAll();
}

function renderAll(){ renderDivers(); renderPairs(); renderGroups(); renderLog(); }

// --- Init/load ---
loadState();
// ensure ids
if(!state.divers || state.divers.length===0) loadState();
// if pairs/groups not exists -> create a few
if(!state.pairs || state.pairs.length===0) state.pairs = [{id:'p1',members:[]},{id:'p2',members:[]},{id:'p3',members:[]},{id:'p4',members:[]}];
if(!state.groups || state.groups.length===0) state.groups = [{id:'g1',members:[],start:'',end:'',name:''},{id:'g2',members:[],start:'',end:'',name:''}];
renderAll();

// --- Buttons ---
document.getElementById('addPair').onclick = ()=>{state.pairs.push({id:'p'+(state.pairs.length+1),members:[]}); saveState(); renderAll();};
document.getElementById('addGroup').onclick = ()=>{state.groups.push({id:'g'+(state.groups.length+1),members:[],start:'',end:'',name:''}); saveState(); renderAll();};

document.getElementById('resetBtn').onclick = ()=>{ if(confirm('Vil du resette til standardliste?')){ state.divers = initialDivers.map((d,i)=>({...d,id:'d'+i})); state.pairs=[]; state.groups=[]; state.log=[]; state.pairs = [{id:'p1',members:[]},{id:'p2',members:[]},{id:'p3',members:[]},{id:'p4',members:[]}]; state.groups = [{id:'g1',members:[],start:'',end:'',name:''},{id:'g2',members:[],start:'',end:'',name:''}]; saveState(); renderAll(); }};

document.getElementById('clearStorage').onclick = ()=>{ if(confirm('Slette gemt data?')){ clearStorage(); }};

document.getElementById('exportCsv').onclick = ()=>{
  // create CSV of log
  let rows = [['groupName','start','end','members']];
  state.log.forEach(r=>rows.push([r.groupName,r.start,r.end,r.members.map(id=>state.divers.find(d=>d.id===id)?.name||id).join(';')]))
  const csv = rows.map(r=>r.map(c=>`"${(c||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='dykker_log.csv'; a.click(); URL.revokeObjectURL(url);
};

// --- simple auto pair (greedy) ---
document.getElementById('autoPairs').onclick = ()=>{
  // put all divers into pairs greedily avoiding 1+3 in same pair
  // clear pairs
  state.pairs = state.pairs.map((p,i)=>({id:'p'+(i+1),members:[]}));
  const free = [...state.divers.map(d=>d.id)];
  const byLvl = {1:free.filter(id=>state.divers.find(d=>d.id===id).lvl===1),2:free.filter(id=>state.divers.find(d=>d.id===id).lvl===2),3:free.filter(id=>state.divers.find(d=>d.id===id).lvl===3)};
  // pair 3 with 2 preferably
  function popFrom(arr){return arr.length?arr.shift():null}
  let pairIdx=0;
  while(byLvl[3].length||byLvl[2].length||byLvl[1].length){
    let a = popFrom(byLvl[3]) || popFrom(byLvl[2]) || popFrom(byLvl[1]);
    let b = null;
    // choose b that doesn't create 1+3
    if(a){
      if(state.divers.find(d=>d.id===a).lvl===3){ b = popFrom(byLvl[2]) || popFrom(byLvl[3]) || popFrom(byLvl[1]); }
      else if(state.divers.find(d=>d.id===a).lvl===1){ b = popFrom(byLvl[1]) || popFrom(byLvl[2]) ; }
      else { b=popFrom(byLvl[2])||popFrom(byLvl[1])||popFrom(byLvl[3]); }
      state.pairs[pairIdx] = state.pairs[pairIdx] || {id:'p'+(pairIdx+1),members:[]};
      if(a) state.pairs[pairIdx].members.push(a);
      if(b) state.pairs[pairIdx].members.push(b);
      pairIdx++;
    }
  }
  saveState(); renderAll();
};

</script>
</body>
</html>
